<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>For My Love ‚Äî Rudra ‚ô•</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1: #fff7fb;
    --bg2: #ffeef6;
    --accent: #ff4f83;
    --muted: #6b6b6b;
    --card: #ffffff;
    --text: #231f20;
  }
  [data-theme="dark"]{
    --bg1: #0b0710;
    --bg2: #2b0f18;
    --accent: #ff6aa2;
    --muted: #cbb7be;
    --card: rgba(18,11,12,0.6);
    --text: #efe6e9;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    color:var(--text);
    background: linear-gradient(180deg, var(--bg1), var(--bg2));
    min-height:100vh;
    overflow:hidden;
  }

  /* Fullpage vertical sections */
  .sections{
    height:100vh; width:100vw; overflow-y:auto; scroll-snap-type:y mandatory;
    -webkit-overflow-scrolling: touch; position:relative;
  }
  section{
    min-height:100vh; scroll-snap-align:start; display:flex; align-items:center; justify-content:center; padding:44px;
    position:relative;
  }

  .site-inner{ width:100%; max-width:1100px; margin:0 auto; display:flex; flex-direction:column; gap:18px; align-items:center; }

  /* Card */
  .card{
    width:100%; background:var(--card); border-radius:16px; padding:22px; box-shadow:0 18px 40px rgba(33,21,24,0.06);
    border: 1px solid rgba(0,0,0,0.04);
  }
  [data-theme="dark"] .card{ box-shadow:0 18px 40px rgba(0,0,0,0.28); border:1px solid rgba(255,255,255,0.03); }

  /* Hero text */
  .hero h1{ margin:0; font-size:28px; line-height:1.05; }
  .hero p{ margin:10px 0 0 0; color:var(--muted); font-size:15px; line-height:1.6; }

  /* Big hearts */
  .big-heart{ position:absolute; width:220px; height:220px; opacity:0.08; pointer-events:none; filter:blur(2px); z-index:2; }
  .big-heart svg{ width:100%; height:100%; }

  /* Songs section */
  .songs-list{ display:flex; flex-direction:column; gap:12px; margin-top:12px; }
  .song{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,245,249,0.9)); }
  .song .meta{ display:flex; flex-direction:column; }
  .song .title{ font-weight:600; }
  .song a{ color:var(--accent); text-decoration:none; font-size:14px; }

  /* Player iframe area */
  .player{ width:100%; height:360px; border-radius:12px; overflow:hidden; margin-top:12px; background:#000; display:flex; align-items:center; justify-content:center; }
  .player iframe{ width:100%; height:100%; border:0; }

  /* Chat center */
  .chat-wrap{ width:100%; max-width:760px; display:flex; flex-direction:column; gap:12px; align-items:center; }
  .chat-box{ width:100%; height:420px; border-radius:12px; padding:14px; overflow:auto; background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,240,246,0.95)); box-shadow:0 12px 30px rgba(0,0,0,0.06); }
  .messages{ display:flex; flex-direction:column; gap:12px; }
  .msg{ max-width:82%; padding:12px 14px; border-radius:12px; }
  .msg.you{ background:#fff2f7; align-self:flex-start; }
  .msg.love{ background: linear-gradient(180deg,var(--accent), #ff7aa0); color:white; align-self:flex-end; }

  .controls{ width:100%; display:flex; gap:8px; }
  .controls input{ flex:1; padding:12px; border-radius:12px; border:1px solid rgba(0,0,0,0.06); font-size:14px; background:transparent; }
  .controls button{ padding:10px 14px; border-radius:12px; border:none; cursor:pointer; background:var(--accent); color:white; font-weight:600; }

  /* Love story */
  textarea{ width:100%; min-height:140px; padding:12px; border-radius:10px; border:1px solid rgba(0,0,0,0.06); background:transparent; resize:vertical; }

  /* Floating hearts (small) */
  .floating { position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:50; }

  .float-heart{ position:absolute; width:34px; height:34px; opacity:0.95; transform:translateY(0); }

  /* nav dots */
  .nav-dots{ position:fixed; right:20px; top:50%; transform:translateY(-50%); display:flex; flex-direction:column; gap:10px; z-index:60; }
  .nav-dot{ width:12px; height:12px; border-radius:50%; background:rgba(0,0,0,0.12); cursor:pointer; }
  .nav-dot.active{ background:var(--accent); box-shadow:0 8px 22px rgba(255,80,130,0.12); }

  /* theme toggle bottom-left */
  .theme-toggle{ position:fixed; left:18px; bottom:18px; z-index:60; background:var(--card); border-radius:14px; padding:8px; box-shadow:0 8px 20px rgba(0,0,0,0.12); cursor:pointer; display:flex; align-items:center; gap:8px; }

  /* responsive */
  @media (max-width:820px){
    .player{ height:240px; }
    .big-heart{ display:none; }
    .chat-box{ height:300px; }
  }
</style>
</head>
<body data-theme="light">

<!-- big hearts in background -->
<div class="big-heart" style="left:6%; top:12%; transform:rotate(-12deg);">
  <svg viewBox="0 0 24 24"><path d="M12 21s-7-4.35-9.07-7.09C.96 9.9 4.34 6 7.5 7.5 9 8.3 10.5 10 12 11.5c1.5-1.5 3-3.2 4.5-4 3.16-1.5 6.54 2.4 4.57 6.41C19 16.65 12 21 12 21z" fill="#ff4f83"/></svg>
</div>
<div class="big-heart" style="right:8%; top:28%; transform:rotate(10deg);">
  <svg viewBox="0 0 24 24"><path d="M12 21s-7-4.35-9.07-7.09C.96 9.9 4.34 6 7.5 7.5 9 8.3 10.5 10 12 11.5c1.5-1.5 3-3.2 4.5-4 3.16-1.5 6.54 2.4 4.57 6.41C19 16.65 12 21 12 21z" fill="#ff7aa0"/></svg>
</div>
<div class="big-heart" style="left:34%; bottom:8%; transform:rotate(-6deg);">
  <svg viewBox="0 0 24 24"><path d="M12 21s-7-4.35-9.07-7.09C.96 9.9 4.34 6 7.5 7.5 9 8.3 10.5 10 12 11.5c1.5-1.5 3-3.2 4.5-4 3.16-1.5 6.54 2.4 4.57 6.41C19 16.65 12 21 12 21z" fill="#ffb3c6"/></svg>
</div>

<!-- floating small hearts layer -->
<div class="floating" id="floating"></div>

<!-- navigation dots -->
<div class="nav-dots" id="navDots"></div>

<!-- sections -->
<div class="sections" id="sections">

  <!-- HERO -->
  <section id="hero">
    <div class="site-inner">
      <div class="card hero">
        <h1>Hi my baby, my love, my jaan ‚Äî my world and my softness ‚ù§Ô∏è</h1>
        <p>
          You are the strength of my heart, my favorite person, my dearest in the universe and every multiverse. You are my everything ‚Äî always and forever. ‚ù§Ô∏è‚Äçüî•
        </p>

        <p style="margin-top:14px;">
          Do you remember that silly night the cockroach appeared while we were talking? Somehow that tiny, unexpected moment turned into one of our funniest and most special memories ‚Äî we still laugh about it! üòÇ‚ù§Ô∏è
        </p>

        <p style="margin-top:12px;">
          And when we held hands on our second date ‚Äî that soft squeeze, that shy finger cuddle ‚Äî it carved itself into my heart. We weren‚Äôt just touching ‚Äî we were promising ‚Äî without words. ü´∂
        </p>

        <p style="margin-top:12px;">
          I always wanted to head-pat you gently. On our first date, I did it with my whole heart ‚Äî and I‚Äôll never have enough. I want to give you all the head pats in the world. ü§ç‚ú®
        </p>

        <p style="margin-top:12px;">
          That sudden head-kiss on our third date? I could feel the world stop. I didn‚Äôt want it to end ‚Äî and honestly, I still don‚Äôt. Kissing you feels like home. üòö
        </p>

        <p style="margin-top:12px; font-weight:700;">
          You are goddamn hot, my lady üî• ‚Äî and I want you to be mine, and mine only. If anyone ever tried to come between us, I‚Äôd do anything to keep you close. Holding your hand is worth everything. ‚ù§Ô∏è
        </p>

        <p style="margin-top:14px; font-size:18px; font-weight:700;">I love you, my Dimp ‚ù§Ô∏è</p>

        <div style="display:flex; gap:12px; justify-content:center; margin-top:16px;">
          <button onclick="scrollToSection('songs')" style="padding:10px 16px; border-radius:12px; background:var(--accent); color:white; border:none; font-weight:600;">Songs for you üé∂</button>
          <button onclick="scrollToSection('chat')" style="padding:10px 16px; border-radius:12px; background:transparent; border:2px solid var(--accent); color:var(--accent); font-weight:600;">Chat with love üí¨</button>
        </div>
      </div>
    </div>
  </section>

  <!-- SONGS -->
  <section id="songs">
    <div class="site-inner">
      <div class="card">
        <h2 style="margin:0">Songs dedicated to you üéµ</h2>
        <p style="color:var(--muted); margin-top:6px;">Click a song to play it. These are YouTube links you provided ‚Äî the player below will load the selected song.</p>

        <div class="songs-list" id="songsList">
          <!-- songs will be rendered here -->
        </div>

        <div class="player card" id="playerArea" style="margin-top:14px;">
          <div id="playerPlaceholder" style="color:#fff; text-align:center; padding:20px;">
            Select a song to play ‚Äî the video will appear here.
          </div>
        </div>
      </div>
    </div>
  </section>
<audio id="bg-music" autoplay loop>
  <source src="https://youtu.be/ZxE0QzE2K9o?si=Sw9AzJOCT9EoHaE9" type="audio/mpeg">
</audio>
  <!-- CHAT -->
  <section id="chat">
    <div class="site-inner">
      <div class="card chat-wrap">
        <div style="text-align:center;">
          <h2 style="margin:0">Talk with love üíû</h2>
          <p style="margin:6px 0 0 0; color:var(--muted);">Ask anything ‚Äî replies always mention Rudra's feelings and how much Rudra loves you.</p>
        </div>

        <div class="chat-box" id="chatBox" role="log" aria-live="polite">
          <div class="messages" id="messages"></div>
        </div>

        <div class="controls">
          <input id="userInput" placeholder="Say something sweet..." onkeydown="if(event.key==='Enter') sendMessage()" />
          <button onclick="sendMessage()">Send</button>
          <button onclick="virtualHug()" style="background:#ff9bb5;">Hug ü§ó</button>
        </div>

        <div style="display:flex; gap:8px; justify-content:space-between; margin-top:10px; width:100%;">
          <div style="display:flex; gap:8px;">
            <button onclick="preset('love')" style="padding:8px 12px; border-radius:10px;">How much do you love me?</button>
            <button onclick="preset('cute')" style="padding:8px 12px; border-radius:10px;">What do you find cute?</button>
            <button onclick="preset('miss')" style="padding:8px 12px; border-radius:10px;">I miss you</button>
          </div>
          <div style="display:flex; gap:8px;">
            <button onclick="saveConversation()" style="padding:8px 12px; border-radius:10px;">Save ‚ù§Ô∏è</button>
            <button onclick="loadConversation()" style="padding:8px 12px; border-radius:10px;">Load</button>
            <button onclick="clearConversation()" style="padding:8px 12px; border-radius:10px;">Clear</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- LOVE STORY -->
  <section id="story">
    <div class="site-inner">
      <div class="card">
        <h3 style="margin:0">Our Love Story ‚ú®</h3>
        <p style="color:var(--muted); margin-top:6px;">Write your story here. It will be saved to your browser (localStorage) so you can keep it private and editable.</p>
        <textarea id="storyArea" placeholder="Write the chapter of our story..."></textarea>
        <div style="display:flex; gap:8px; margin-top:10px;">
          <button onclick="saveStory()">Save Story</button>
          <button onclick="loadStory()">Load Story</button>
          <button onclick="clearStory()">Clear</button>
        </div>
      </div>
    </div>
  </section>

</div>

<!-- theme toggle -->
<div class="theme-toggle" id="themeToggle" title="Toggle dark / light">
  <span id="themeIcon">üåô</span><span style="font-size:13px;color:var(--muted)">Theme</span>
</div>

<script>
/* =================== Configuration (Edit here) ===================
  - HF_ENDPOINT: Hugging Face inference endpoint (optional)
    e.g. "https://api-inference.huggingface.co/models/gpt2"
  - HF_TOKEN: Optional Bearer token if required (some models)
  - NICKNAME: Name used in messages (e.g. "love" or her real nickname)
  - OWNER_NAME: Your name (Rudra) used in AI prompts
================================================================= */
let HF_ENDPOINT = ""; // paste HF inference endpoint if you want serverless HF calls (CORS required)
let HF_TOKEN = "";    // optional

let NICKNAME = "love";
let OWNER_NAME = "Rudra";

/* =================== Provided YouTube songs (IDs extracted) =================== */
const SONGS = [
  { title: "Song 1", yt: "AbkEmIgJMcU" },
  { title: "Song 2", yt: "AXeB1vrz7II" },
  { title: "Song 3", yt: "KigR4MQUxE8" },
  { title: "Song 4", yt: "fpc3cdpVc9M" },
  { title: "Song 5", yt: "tYWzm47lYpc" }
];
/* ======================================================================= */

/* Helper */
function e(s){ return document.querySelector(s); }
function create(tag, props={}, children=[]) {
  const el = document.createElement(tag);
  Object.assign(el, props);
  children.forEach(c => el.appendChild(c));
  return el;
}

/* Build songs list */
function renderSongs(){
  const list = e('#songsList');
  list.innerHTML = "";
  SONGS.forEach((s, idx) => {
    const div = create('div', { className: 'song' });
    const meta = create('div', { className: 'meta' });
    meta.innerHTML = `<div class="title">${escapeHtml(s.title)}</div><div style="font-size:13px;color:var(--muted)">YouTube ‚Ä¢ ${s.yt}</div>`;
    const actions = create('div', {});
    const playBtn = create('button', { innerText: 'Play', onclick: ()=> playSong(s.yt) , style: 'padding:8px 12px;border-radius:8px;background:var(--accent);color:#fff;border:none;cursor:pointer;' });
    const openBtn = create('a', { innerText: 'Open', href: 'https://youtu.be/' + s.yt, target: '_blank', style: 'padding:8px 12px;border-radius:8px;background:transparent;border:1px solid var(--accent);color:var(--accent);text-decoration:none;margin-left:8px;display:inline-block;' });
    actions.appendChild(playBtn);
    actions.appendChild(openBtn);
    div.appendChild(meta);
    div.appendChild(actions);
    list.appendChild(div);
  });
}

/* Player - load YouTube embed */
function playSong(id){
  const player = e('#playerArea');
  player.innerHTML = '';
  const iframe = create('iframe', { src: `https://www.youtube.com/embed/${id}?autoplay=1&rel=0`, frameBorder:0, allow: 'autoplay; encrypted-media; picture-in-picture', allowFullscreen: true });
  player.appendChild(iframe);
  // scroll to player
  player.scrollIntoView({ behavior:'smooth', block:'center' });
}

/* Escape html */
function escapeHtml(t){ return String(t).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* =================== Chat & AI logic =================== */
const messagesEl = e('#messages');
const chatBox = e('#chatBox');
const userInput = e('#userInput');

function addMessage(text, who='love'){
  const div = create('div', { className: 'msg ' + (who==='you' ? 'you' : 'love') });
  div.innerHTML = escapeHtml(text);
  messagesEl.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
  saveToLocal('convo', { who, text, time: Date.now() });
}

/* initial warm greeting (improved text) */
function initialGreeting(){
  addMessage(`Hi ${NICKNAME} ‚Äî you are the softness of my world, the strength of my heart, my favorite person in every universe. ‚ù§Ô∏è`, 'love');
  setTimeout(()=> addMessage(`Do you remember the cockroach moment? It turned into one of our funniest memories üòÇ ‚Äî and when we held hands on our second date, my heart learned a new rhythm. ü´∂`, 'love'), 800);
  setTimeout(()=> addMessage(`I love head pats, head kisses, and every small thing that makes you smile. I want to give you all of them forever. ü§ç`, 'love'), 1600);
  setTimeout(()=> addMessage(`Rudra loves you this much: ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è ‚Äî talking to you is my peace.`, 'love'), 2400);
}

/* Build HF prompt so replies always mention Rudra and Rudra's feelings */
function buildPrompt(userText){
  return `
You are a gentle, affectionate assistant speaking for ${OWNER_NAME} (Rudra). Always produce short tender replies that mention Rudra's feelings and how much Rudra loves the user.
Rules:
- Begin or end with a short line like "Rudra loves you this much: ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è".
- Mention Rudra by name at least once.
- Keep tone affectionate and safe. If user expresses anger, convert it into protective, loving language (no violent or explicit threats).
- Include small sweet examples of Rudra's affection (holding hands, head pats, hugs) where appropriate.
User: "${userText}"
Assistant:
`;
}

/* Hugging Face call (if configured). Returns generated text or null */
async function callHF(prompt){
  if(!HF_ENDPOINT) return null;
  try{
    const headers = { 'Content-Type': 'application/json' };
    if(HF_TOKEN) headers['Authorization'] = 'Bearer ' + HF_TOKEN;
    const resp = await fetch(HF_ENDPOINT, {
      method: 'POST',
      headers,
      body: JSON.stringify({ inputs: prompt, options: { wait_for_model: true } })
    });
    if(!resp.ok) {
      console.warn('HF error', resp.status);
      return null;
    }
    const data = await resp.json();
    if(typeof data === 'string') return data;
    if(Array.isArray(data) && data[0] && data[0].generated_text) return data[0].generated_text;
    if(data.generated_text) return data.generated_text;
    if(Array.isArray(data) && data[0] && data[0].body) return data[0].body;
    return JSON.stringify(data);
  }catch(err){
    console.warn('HF call failed', err);
    return null;
  }
}

/* Local fallback replies (always refer to Rudra) */
function localReply(text){
  const t = text.toLowerCase();
  let base = "Rudra loves you this much: ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è";
  let resp = "";
  if(t.includes('love') || t.includes('how much')) resp = `${base} Rudra says: I love you beyond words, ${NICKNAME}. My heart is yours.`;
  else if(t.includes('cute') || t.includes('adorable')) resp = `${base} Rudra finds your every smile adorable ‚Äî you make the world gentle.`;
  else if(t.includes('miss')) resp = `${base} Rudra misses you deeply ‚Äî he counts every moment until he can hold your hand again.`;
  else if(t.includes('sad') || t.includes('hurt')) resp = `${base} Rudra will hold you close and make everything softer. You're never alone.`;
  else resp = `${base} Rudra says: talking to you is my calm, ${NICKNAME}. I am so grateful for you.`;
  return resp;
}

/* Send message flow */
let sending = false;
async function sendMessage(){
  if(sending) return;
  const text = userInput.value.trim();
  if(!text) return;
  userInput.value = '';
  addMessage(text, 'you');

  // typing indicator
  const typing = create('div', { className: 'msg love' });
  typing.innerHTML = 'love is typing‚Ä¶';
  messagesEl.appendChild(typing);
  chatBox.scrollTop = chatBox.scrollHeight;

  sending = true;
  let reply = null;

  // Build prompt for HF
  const prompt = buildPrompt(text);

  // Try HF if endpoint set
  if(HF_ENDPOINT){
    const hf = await callHF(prompt);
    if(hf) reply = String(hf).trim();
  }

  // Fallback if HF not available or failed
  if(!reply) reply = localReply(text);

  // show reply after short delay
  const delay = Math.min(1200 + reply.length * 6, 2600);
  setTimeout(()=> {
    typing.remove();
    addMessage(reply, 'love');
    sending = false;
  }, delay);
}

/* Presets */
function preset(type){
  const map = { love: 'How much do you love me?', cute: 'What do you find cute about me?', miss: 'I miss you' };
  userInput.value = map[type] || '';
  sendMessage();
}
document.getElementById("bg-music").volume = 0.8;

/* Virtual hug */
function virtualHug(){
  spawnHearts(10);
  addMessage(`Rudra sends a warm hug ü§ó ‚Äî come closer, ${NICKNAME}!`, 'love');
}

/* ================= Persistence: conversation & story ================= */
function saveToLocal(key, value){
  try { localStorage.setItem('cute_' + key, JSON.stringify(value)); } catch(e){ console.warn(e); }
}
function readFromLocal(key){
  try { return JSON.parse(localStorage.getItem('cute_' + key)); } catch(e){ return null; }
}

/* Save conversation (already auto-saved per message) */
function saveConversation(){
  alert('Conversation saved locally in your browser ‚ù§Ô∏è');
}
function loadConversation(){
  const arr = readFromLocal('convo') || [];
  messagesEl.innerHTML = '';
  arr.forEach(m => {
    addMessage(m.text, m.who);
  });
}
function clearConversation(){
  if(!confirm('Clear conversation?')) return;
  localStorage.removeItem('cute_convo');
  messagesEl.innerHTML = '';
}

/* Save delay wrapper for auto save of messages */
(function autoSaveOverride(){
  const orig = saveToLocal;
  // push message saver: we append each message to cute_convo
  const _oldAdd = addMessage;
  window.addMessage = function(text, who){ // override (keeps original signature)
    // keep display using original
    const div = create('div', { className: 'msg ' + (who==='you' ? 'you' : 'love') });
    div.innerHTML = escapeHtml(text);
    messagesEl.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;

    // persist into array
    try{
      const key = 'cute_convo';
      const arr = JSON.parse(localStorage.getItem(key) || "[]");
      arr.push({ who, text, time: Date.now() });
      localStorage.setItem(key, JSON.stringify(arr));
    }catch(e){ console.warn(e); }
  };
  // replace local addMessage reference used elsewhere
  window.addMessage = window.addMessage;
})();

/* Love story persistence */
function saveStory(){
  const v = e('#storyArea').value || '';
  localStorage.setItem('cute_story', v);
  alert('Love story saved locally ‚ù§Ô∏è');
}
function loadStory(){
  const v = localStorage.getItem('cute_story') || '';
  e('#storyArea').value = v;
}
function clearStory(){
  if(!confirm('Clear story?')) return;
  localStorage.removeItem('cute_story');
  e('#storyArea').value = '';
}

/* ================= Floating hearts animation ================= */
const floating = e('#floating');
function spawnHearts(count=6){
  for(let i=0;i<count;i++){
    const h = create('div', { className: 'float-heart' });
    const left = Math.random() * 95;
    const top = Math.random() * 90;
    h.style.left = left + '%';
    h.style.top = top + '%';
    h.innerHTML = `<svg viewBox="0 0 24 24" width="100%" height="100%"><path fill="#ff4f83" d="M12 21s-7-4.35-9.07-7.09C.96 9.9 4.34 6 7.5 7.5 9 8.3 10.5 10 12 11.5c1.5-1.5 3-3.2 4.5-4 3.16-1.5 6.54 2.4 4.57 6.41C19 16.65 12 21 12 21z"/></svg>`;
    floating.appendChild(h);
    // animate
    setTimeout(()=> { h.style.transition = 'transform 1600ms ease-out, opacity 1600ms'; h.style.transform = 'translateY(-120px) scale(0.85)'; h.style.opacity = '0'; }, 80 + Math.random()*300);
    setTimeout(()=> h.remove(), 1800 + Math.random()*400);
  }
}

/* Spawn small hearts regularly */
setInterval(()=> spawnHearts(3), 2800);

/* ================= Theme toggle ================= */
const themeToggle = e('#themeToggle');
function setTheme(t){
  document.body.setAttribute('data-theme', t === 'dark' ? 'dark' : 'light');
  e('#themeIcon').textContent = (t === 'dark' ? '‚òÄÔ∏è' : 'üåô');
  localStorage.setItem('cute_theme', t === 'dark' ? 'dark' : 'light');
}
themeToggle.addEventListener('click', ()=>{
  setTheme(document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
});

/* ================= Nav dots logic ================= */
const sections = Array.from(document.querySelectorAll('.sections section'));
const navDots = e('#navDots');
sections.forEach((s, i)=> {
  const dot = create('div', { className: 'nav-dot' });
  if(i===0) dot.classList.add('active');
  dot.onclick = ()=> scrollToSection(s.id);
  navDots.appendChild(dot);
});
function updateDots(){
  const top = document.getElementById('sections').scrollTop;
  const idx = Math.round(top / window.innerHeight);
  Array.from(navDots.children).forEach((d, i)=> d.classList.toggle('active', i===idx));
}
e('#sections').addEventListener('scroll', updateDots);
function scrollToSection(id){
  const el = document.getElementById(id);
  if(el) el.scrollIntoView({ behavior:'smooth' });
}

/* ================= Startup: render songs, greeting, theme, restore data ================= */
function init(){
  renderSongs();
  // load saved convo into messages area
  const conv = JSON.parse(localStorage.getItem('cute_convo') || "[]");
  messagesEl.innerHTML = '';
  conv.forEach(m => {
    const div = create('div', { className: 'msg ' + (m.who==='you' ? 'you' : 'love') });
    div.innerHTML = escapeHtml(m.text);
    messagesEl.appendChild(div);
  });

  // Load story
  loadStory();

  // apply theme if saved
  const saved = localStorage.getItem('cute_theme') || 'light';
  setTheme(saved);

  // initial greeting if no conversation
  if(!conv || conv.length === 0) initialGreeting();
}
init();

/* ================= Utility: save message push used earlier (fallback) ================= */
function saveToLocalConvo(who, text){
  try{
    const key = 'cute_convo';
    const arr = JSON.parse(localStorage.getItem(key) || "[]");
    arr.push({ who, text, time: Date.now() });
    localStorage.setItem(key, JSON.stringify(arr));
  }catch(e){ console.warn(e); }
}

/* Overwrite addMessage to also persist (ensures both UI + storage) */
(function overrideAdd(){
  const original = window.addMessage;
  window.addMessage = function(text, who){
    // UI
    const div = create('div', { className: 'msg ' + (who==='you' ? 'you' : 'love') });
    div.innerHTML = escapeHtml(text);
    messagesEl.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
    // persist
    saveToLocalConvo(who, text);
  };
})();

/* Replace push to use new addMessage */
function pushUser(text){
  // Called when user sends
  addMessage = window.addMessage; // ensure reference
  addMessage(text, 'you');
}

/* Save conversation alias */
function saveConversation(){ alert('Conversation is auto-saved in your browser ‚ù§Ô∏è'); }

/* Load conversation from storage */
function loadConversation(){
  const arr = JSON.parse(localStorage.getItem('cute_convo') || "[]");
  messagesEl.innerHTML = '';
  arr.forEach(m => {
    const div = create('div', { className: 'msg ' + (m.who==='you' ? 'you' : 'love') });
    div.innerHTML = escapeHtml(m.text);
    messagesEl.appendChild(div);
  });
}

/* Clear conversation */
function clearConversation(){
  if(!confirm('Clear conversation history?')) return;
  localStorage.removeItem('cute_convo');
  messagesEl.innerHTML = '';
}

/* Ensure sending uses the earlier sendMessage logic but persists using our addMessage override */
async function sendMessage(){
  if(window.sending) return;
  const text = userInput.value.trim();
  if(!text) return;
  userInput.value = '';
  // UI + persist (you)
  window.addMessage(text, 'you');

  // typing indicator
  const typing = create('div', { className: 'msg love' });
  typing.innerHTML = 'love is typing‚Ä¶';
  messagesEl.appendChild(typing);
  chatBox.scrollTop = chatBox.scrollHeight;

  window.sending = true;
  // try HF
  let reply = null;
  const prompt = buildPrompt(text);
  if(HF_ENDPOINT){
    const hf = await callHF(prompt);
    if(hf) reply = String(hf).trim();
  }
  if(!reply) reply = localReply(text);

  const delay = Math.min(1200 + reply.length * 6, 2600);
  setTimeout(()=> {
    typing.remove();
    window.addMessage(reply, 'love');
    window.sending = false;
  }, delay);
}

/* small helper to call sendMessage from other places */
window.sendMessage = sendMessage;

/* small create preset wrapper */
function preset(k){ userInput.value = (k==='love' ? 'How much do you love me?' : k==='cute' ? 'What do you find cute about me?' : 'I miss you'); sendMessage(); }

/* expose virtual hug */
window.virtualHug = virtualHug;

/* small util to escape html for storage->DOM */
function escapeHtml(t){ return String(t).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
</script>
</body>
</html>
